<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="789px" preserveAspectRatio="none" style="width:721px;height:789px;" version="1.1" viewBox="0 0 721 789" width="721px" zoomAndPan="magnify"><defs><filter height="300%" id="f1rvbqmc4c5gxz" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1rvbqmc4c5gxz)" height="480.8989" style="stroke: #000000; stroke-width: 2.0;" width="587.5" x="122" y="201.3833"/><rect fill="#FFFFFF" height="158.0405" style="stroke: none; stroke-width: 1.0;" width="587.5" x="122" y="252.915"/><rect fill="#FFFFFF" height="271.3267" style="stroke: none; stroke-width: 1.0;" width="587.5" x="122" y="410.9556"/><rect fill="#FFFFFF" filter="url(#f1rvbqmc4c5gxz)" height="194.5493" style="stroke: #000000; stroke-width: 2.0;" width="476.5" x="132" y="480.7329"/><rect fill="#FFFFFF" height="33.7544" style="stroke: none; stroke-width: 1.0;" width="476.5" x="132" y="641.5278"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="25" x2="25" y1="89.1201" y2="699.2822"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="92" x2="92" y1="89.1201" y2="699.2822"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="176" x2="176" y1="89.1201" y2="699.2822"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="399" x2="399" y1="89.1201" y2="699.2822"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="568.5" x2="568.5" y1="89.1201" y2="699.2822"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="653.5" x2="653.5" y1="89.1201" y2="699.2822"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="28" x="8" y="86.0439">用户</text><ellipse cx="25" cy="13" fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M25,21 L25,48 M12,29 L38,29 M25,48 L12,63 M25,48 L38,63 " fill="none" filter="url(#f1rvbqmc4c5gxz)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="28" x="8" y="714.3262">用户</text><ellipse cx="25" cy="727.4023" fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M25,735.4023 L25,762.4023 M12,743.4023 L38,743.4023 M25,762.4023 L12,777.4023 M25,762.4023 L38,777.4023 " fill="none" filter="url(#f1rvbqmc4c5gxz)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="52" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="59" y="74.0439">WEB/APP</text><rect fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="76" x="52" y="698.2822"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="62" x="59" y="721.3262">WEB/APP</text><rect fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="64" x="142" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="149" y="74.0439">DEVICE</text><rect fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="64" x="142" y="698.2822"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="50" x="149" y="721.3262">DEVICE</text><rect fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="362" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="369" y="74.0439">SERVER</text><rect fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="70" x="362" y="698.2822"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="56" x="369" y="721.3262">SERVER</text><rect fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="55" x="539.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="546.5" y="74.0439">REDIS</text><rect fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="55" x="539.5" y="698.2822"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="41" x="546.5" y="721.3262">REDIS</text><rect fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="608.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="615.5" y="74.0439">DATABASE</text><rect fill="#FEFECE" filter="url(#f1rvbqmc4c5gxz)" height="33.1201" style="stroke: #A80036; stroke-width: 1.5;" width="87" x="608.5" y="698.2822"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="73" x="615.5" y="721.3262">DATABASE</text><polygon fill="#A80036" points="387,118.8745,397,122.8745,387,126.8745,391,122.8745" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="176" x2="393" y1="122.8745" y2="122.8745"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="134" x="183" y="118.0181">func?token=&amp;deviceId=</text><polygon fill="#A80036" points="557,150.6289,567,154.6289,557,158.6289,561,154.6289" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="399" x2="563" y1="154.6289" y2="154.6289"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="110" x="406" y="149.7725">查询token是否过期</text><polygon fill="#A80036" points="410,182.3833,400,186.3833,410,190.3833,406,186.3833" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="404" x2="568" y1="186.3833" y2="186.3833"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="84" x="416" y="181.5269">检查token状态</text><path d="M122,201.3833 L183,201.3833 L183,210.3833 L173,220.3833 L122,220.3833 L122,201.3833 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="480.8989" style="stroke: #000000; stroke-width: 2.0;" width="587.5" x="122" y="201.3833"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="137" y="217.2813">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="62" x="198" y="215.9893">[token有效]</text><polygon fill="#A80036" points="187,240.915,177,244.915,187,248.915,183,244.915" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="181" x2="398" y1="244.915" y2="244.915"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="193" y="240.0586">返回结果</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="122" x2="709.5" y1="253.915" y2="253.915"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="62" x="127" y="266.521">[token更新]</text><polygon fill="#A80036" points="187,289.6924,177,293.6924,187,297.6924,183,293.6924" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="181" x2="398" y1="293.6924" y2="293.6924"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="193" y="288.8359">新token</text><polygon fill="#A80036" points="387,321.4468,397,325.4468,387,329.4468,391,325.4468" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="176" x2="393" y1="325.4468" y2="325.4468"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="183" y="320.5903">收到新token 老token=&amp;新token=</text><polygon fill="#A80036" points="557,353.2012,567,357.2012,557,361.2012,561,357.2012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="399" x2="563" y1="357.2012" y2="357.2012"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="406" y="352.3447">过期老token,新token生效</text><polygon fill="#A80036" points="410,367.2012,400,371.2012,410,375.2012,406,371.2012" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="404" x2="568" y1="371.2012" y2="371.2012"/><polygon fill="#A80036" points="187,398.9556,177,402.9556,187,406.9556,183,402.9556" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="181" x2="398" y1="402.9556" y2="402.9556"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="193" y="398.0991">更新成功</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="122" x2="709.5" y1="411.9556" y2="411.9556"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="62" x="127" y="424.5615">[token失效]</text><polygon fill="#A80036" points="642,447.7329,652,451.7329,642,455.7329,646,451.7329" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="399" x2="648" y1="451.7329" y2="451.7329"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="406" y="446.8765">设备是否初始化状态(deviceId)</text><polygon fill="#A80036" points="410,461.7329,400,465.7329,410,469.7329,406,465.7329" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="404" x2="653" y1="465.7329" y2="465.7329"/><path d="M132,480.7329 L193,480.7329 L193,489.7329 L183,499.7329 L132,499.7329 L132,480.7329 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="194.5493" style="stroke: #000000; stroke-width: 2.0;" width="476.5" x="132" y="480.7329"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="147" y="496.6309">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="63" x="208" y="495.3389">[初始化状态]</text><polygon fill="#A80036" points="187,520.2646,177,524.2646,187,528.2646,183,524.2646" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="181" x2="398" y1="524.2646" y2="524.2646"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="45" x="193" y="519.4082">新token</text><polygon fill="#A80036" points="387,552.019,397,556.019,387,560.019,391,556.019" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="176" x2="393" y1="556.019" y2="556.019"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="183" y="551.1626">收到新token 老token=&amp;新token=</text><polygon fill="#A80036" points="557,583.7734,567,587.7734,557,591.7734,561,587.7734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="399" x2="563" y1="587.7734" y2="587.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="146" x="406" y="582.917">过期老token,新token生效</text><polygon fill="#A80036" points="410,597.7734,400,601.7734,410,605.7734,406,601.7734" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="404" x2="568" y1="601.7734" y2="601.7734"/><polygon fill="#A80036" points="187,629.5278,177,633.5278,187,637.5278,183,633.5278" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="181" x2="398" y1="633.5278" y2="633.5278"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="193" y="628.6714">更新成功</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="132" x2="608.5" y1="642.5278" y2="642.5278"/><polygon fill="#A80036" points="187,663.2822,177,667.2822,187,671.2822,183,667.2822" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="181" x2="398" y1="667.2822" y2="667.2822"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="199" x="193" y="662.4258">设备已过期,请管理员重置链接状态</text><!--MD5=[81190bc069731b4802b107390807108c]
@startuml
Actor "用户" as user
participant  "WEB/APP" as view order 50
participant  "DEVICE" as iot order 60
participant  "SERVER" as back order 100
participant  "REDIS" as redis order 150
participant  "DATABASE" as db order 200


iot->back: func?token=&deviceId=
back->redis: 查询token是否过期
redis- ->back: 检查token状态
alt token有效
back- ->iot: 返回结果 
else token更新
back- ->iot: 新token
iot->back: 收到新token 老token=&新token=
back->redis: 过期老token,新token生效
redis- ->back
back- ->iot: 更新成功
else token失效
back->db: 设备是否初始化状态(deviceId)
db- ->back
alt 初始化状态
back- ->iot: 新token
iot->back: 收到新token 老token=&新token=
back->redis: 过期老token,新token生效
redis- ->back
back- ->iot: 更新成功
else
back- ->iot: 设备已过期,请管理员重置链接状态
end
end

@enduml

PlantUML version 1.2019.10(Sat Sep 14 04:53:03 CST 2019)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 11.0.4+10-b304.69
Operating System: Windows 10
Default Encoding: GBK
Language: zh
Country: CN
--></g></svg>